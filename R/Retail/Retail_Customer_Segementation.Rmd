---
title: "Retail Customer Segmentation"
author: "Indu Sen"
date: "2024-01-31"
output: html_document
---

# Retail Customer Analytics

## Load libaries 

```{r}

library(dplyr)
library(readxl)
library(lubridate)
library(ggplot2)

```

## Read in data

```{r}
library(readxl)
dataset <- read_xlsx("/Users/indusen/Downloads/Online Retail.xlsx")
```

## Data cleaning

```{r}
summary(dataset)
```

```{r}
glimpse(dataset)
```

Filtering Quantity to remove negative values: 

```{r}
summary(dataset$Quantity)
```

```{r}
dataset <- dataset %>% filter(Quantity>=0)
```

### Checking for null values

```{r}

sum(is.na(dataset))

```

```{r}
names(which(sapply(dataset, anyNA)))

names
```

Filtering CutomerID to remove NA values: 

```{r}
dataset <- dataset %>% filter(!is.na(CustomerID))
```

```{r}
sum(is.na(dataset))
```

## Feature engineering - create new columns and dataframes

```{r}
items <- dataset %>%
  mutate(items_sales = Quantity * UnitPrice) %>%
  mutate(sales_date = as.Date(InvoiceDate)) %>%
  mutate(sales_year_month = floor_date(InvoiceDate, unit = "month"))
```

### Daily Sales

```{r}

daily <- items %>%
         group_by(CustomerID,sales_date,sales_year_month) %>%
         summarise(daily_sale = sum(items_sales))

```
### Monthly Sales 

```{r}

monthly <- daily %>%
           group_by(CustomerID, sales_year_month) %>%
           summarise(monthly_sales = sum(daily_sale))

```

```{r}

customer_summary <- monthly %>% 
                    group_by(CustomerID) %>%
                    summarise(total_customer_sales = sum(monthly_sales)) %>%
                    arrange(desc(total_customer_sales))
```

## Exploratory analysis 

```{r}
cust_plot <- ggplot(customer_summary,aes(x=CustomerID, y = total_customer_sales)) + 
             geom_point(shape = 1) +
             geom_hline(yintercept = 5000, color = "red")

cust_plot
```

Finding the wholesale customers

```{r}

wholesale <- customer_summary %>%
              filter(total_customer_sales >=5000)

wholesale

# See the percentage of wholesale customers

nrow(wholesale)/nrow(customer_summary)

# See the percentage of wholesale customers' sales volume

sum(wholesale$total_customer_sales)/sum(customer_summary$total_customer_sales)
```
## RFM 

## RFM Customer Segmentation 

RFM analysis is a data driven customer behavior segmentation technique.

RFM stands for recency, frequency, and monetary value.

The  idea is to segment customers based on when their last purchase was, how often they’ve purchased in the past, and how much they’ve spent overall. 

For more information, click [here](https://www.barilliance.com/rfm-analysis/#:~:text=RFM%20stands%20for%20recency%2C%20frequency,much%20they've%20spent%20overall.). 

### Recency 

```{r}

most_recent_month <- max(monthly$sales_year_month)

recency <- monthly %>%
           mutate(period = as.numeric(most_recent_month-sales_year_month))

```

### Frequency 

```{r}

freq <- monthly %>%
        group_by(CustomerID) %>%
        summarise(freq = n())
        

```

### Monetary

```{r}

monetary <- monthly %>%
        group_by(CustomerID) %>%
        summarise(monetary = sum(monthly_sales))
```

### Most Recent

```{r}

most_recent <- recency %>%
        group_by(CustomerID) %>%
        summarise(most_recent = min(period)*-1)
```

### Bind the data frame

```{r}

combined_dfs <- bind_cols(freq, monetary, most_recent, by=c("CustomerID")) %>%
                rename(id=1) %>%
                select(id,freq,monetary,most_recent)

```

```{r}
rfm_wholesale <- inner_join(combined_dfs, wholesale, by=c("id"="CustomerID")) %>%
                 select(id,freq,monetary,most_recent)
                  
```

### Build Buckets

```{r}
rfm <- rfm_wholesale %>%
       mutate(bucket_freq = ntile(freq,3)) %>%
       mutate(bucket_monetary = ntile(monetary,3)) %>%
       mutate(bucket_recency = ntile(most_recent,3))
```

### RFM segments

```{r}
rfm_segments <- rfm %>%
                mutate(segment = paste0(as.character(bucket_recency),as.character(bucket_freq),as.character(bucket_monetary)))
```

```{r}

mvc <- rfm_segments %>%
       filter(segment == '333')

needs_attention <- rfm_segments %>%
                   filter(bucket_monetary == 3 & bucket_recency == 1)

needs_attention
```
  
